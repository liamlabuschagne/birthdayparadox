<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Birthday Paradox</h1>
    <div id="room-selection">
        <p id="error" style="display: none;color:red">Room not found</p>
        <input type="text" name="room" id="room" placeholder="Room ID">
        <button id="select-room">Select</button>
        <p>or</p>
        <button id="create-room">Create new room</button>
    </div>
    <div id="enter-birthday" style="display: none;">
        <button class="home">Home</button>
        <h2>Enter Your Birthday</h2>
        <input type="date" name="birthday" id="birthday">
        <button id="submit-birthday">Submit</button>
    </div>
    <div id="results" style="display: none;">
        <h2>Results</h2>
        <button class="home">Home</button>
        <p id="room-id"></p>
        <button id="delete">Delete Room</button>
        <div id="birthdays"></div>
    </div>
    
    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://skhnvdfdccmmacpofcla.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNraG52ZGZkY2NtbWFjcG9mY2xhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTU4NDA1OTEsImV4cCI6MjAzMTQxNjU5MX0.m89dtPlI3T-CZXtzHJ-SAC-D00G8KkFuNH_p-4H4lHA';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        let user = localStorage.getItem('user')
        let roomId = localStorage.getItem('room');
        let previousResultCount = 0;
        const pages = ['room-selection', 'enter-birthday', 'results']

        function setup(){
            // If the uuid is not found, create a new one
            if (!user) {
                user = crypto.randomUUID()
                localStorage.setItem('user', user)
            }
            
            // Maintain page persistance after refesh
            if(localStorage.getItem('page')) {
                showPage(localStorage.getItem('page'))
            } else {
                showPage('room-selection')
            }

            // If we already have a room, show the results
            if (roomId) {
                selectRoom(roomId) // Ensure the room id is displayed
                showPage('results')
                getBirthdays()
            }

            // Every second, get the latest results
            setInterval(() => {
                getBirthdays()
            }, 1000)
        }
        setup()

        // Show page function (and hide all the others)
        function showPage(page) {
            pages.forEach(p => {
                if (p === page) {
                    // Store what page we are on in local storage
                    localStorage.setItem('page', page)

                    document.querySelector(`#${p}`).style.display = 'block'
                } else {
                    document.querySelector(`#${p}`).style.display = 'none'
                }
            })
        }

        function selectRoom(room){
            roomId = room

            // Store this in local storage
            localStorage.setItem('room', room)

            // Update the room id in the DOM
            document.querySelector('#room-id').innerText = `Room ID: ${room}`
        }

        // Handle when the user selects a room
        document.querySelector('#select-room').addEventListener('click', async () => {
            selectRoom(document.querySelector('#room').value);
           
            const result = await getBirthdays()
            if (result === false) {
                // Delete the room from local storage
                localStorage.removeItem('room')
                roomId = null
                return
            }

            previousResultCount = 0

            // Check if we haven't already stored this birthday
            if (localStorage.getItem(roomId)) {
                console.log('Birthday already stored')
                showPage('results')
                return
            }
            showPage('enter-birthday')
        })

        // Handle when the user creates a new room
        document.querySelector('#create-room').addEventListener('click', async () => {
            showPage('enter-birthday')
        })

        // Handle when the user submits a birthday
        document.querySelector('#submit-birthday').addEventListener('click', async () => {
            const birthday = document.querySelector('#birthday').value
            await submitBirthday(birthday)
            showPage('results')
            getBirthdays()
        })

        // Handle when the user clicks the home button
        document.querySelectorAll('.home').forEach((e) => e.addEventListener('click', () => {
            // Leave the current room
            localStorage.removeItem('room')

            // Loose ownership of the room
            localStorage.removeItem('owned')

            showPage('room-selection')
        }))

        // Handle when the user clicks the delete button
        document.querySelector('#delete').addEventListener('click', () => {
            deleteRoom()
        })

        async function deleteRoom(){
            if(!roomId) return

            // Check the room I'm on is mine
            if(!localStorage.getItem('owned') || localStorage.getItem('owned') !== roomId) return

            const { error } = await supabaseClient.from('birthdays').delete().eq('room', roomId)

            if (error) {
                console.error('Error deleting data:', error.message)
                return
            }

            console.log('Data deleted successfully')

            // Remove the room from local storage
            localStorage.removeItem('room')
            roomId = null

            // Remove room ownership from local storage
            localStorage.removeItem('owned')

            // Show the room selection page
            showPage('room-selection')
        }

        async function getBirthdays() {

            if(!roomId) return

            // Get all the birthdays in this room
            const {data, error} = await supabaseClient.from('birthdays').select().eq('room', roomId)

            if (error) {
                console.error('Error getting data:', error.message)
                return
            }

            // If the data is empty, reload the page to reset
            if (data.length === 0) {

                // Show an error message
                document.querySelector('#error').style.display = 'block'
                setTimeout(() => {
                    document.querySelector('#error').style.display = 'none'
                }, 3000)
                return false
            }
            
            if(previousResultCount === data.length) return
            
            previousResultCount = data.length

            // See if there any duplicates
            let duplicates = data.reduce((acc, birthday) => {
                if (acc[birthday.birthday]) {
                    acc[birthday.birthday]++
                } else {
                    acc[birthday.birthday] = 1
                }
                return acc
            }, {})

            // Sort the birthdays by the number of duplicates
            data.sort((a, b) => duplicates[b.birthday] - duplicates[a.birthday])

            // Display the birthdays in the DOM
            const birthdays = data.map(birthday => {

                if(duplicates[birthday.birthday] === 0) return
                
                let count = duplicates[birthday.birthday];
                
                // Set the count to zero to indicate it has been printed
                duplicates[birthday.birthday] = 0
                
                // Convert to a human-readable date, removing the year
                birthday.birthday = new Date(birthday.birthday).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })

                if (count > 1) {
                    return `<p>${birthday.birthday} (${count} people)</p>`
                }

                return `<p>${birthday.birthday}</p>`
            })

            document.querySelector('#birthdays').innerHTML = birthdays.join('')
        }

        async function submitBirthday(birthday) {

            if(!roomId){
                // Truncated uuid
                roomId = crypto.randomUUID().slice(0, 6)
                selectRoom(roomId)
            }

            previousResultCount = 0

            let data = { birthday: birthday, created_by: user, room: roomId}

            const { error } = await supabaseClient.from('birthdays').insert(data)

            if (error) {
                console.error('Error inserting data:', error.message)
                return
            }

            console.log('Data inserted successfully')

            // Store the room id in the local storage
            localStorage.setItem(roomId, birthday)

            // Store the room as mine
            localStorage.setItem('owned', roomId)

            // Hide the birthday input
            document.querySelector('#birthday').style.display = 'none'
        }

    </script>
</body>
</html>
