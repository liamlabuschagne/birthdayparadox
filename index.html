<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Birthday Paradox</h1>
    <div id="room-selection">
        <p id="error" style="display: none;color:red">Room not found</p>
        <input type="text" name="room" id="room" placeholder="Room ID">
        <button id="select-room">Select</button>
        <p>or</p>
        <button id="create-room">Create new room</button>
    </div>
    <div id="enter-birthday" style="display: none;">
        <input type="date" name="birthday" id="birthday">
        <button id="submit-birthday">Submit</button>
    </div>
    <div id="results" style="display: none;">
        <h2>Results</h2>
        <button id="Home">Home</button>
        <p id="room-id"></p>
        <div id="birthdays"></div>
    </div>
    
    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://skhnvdfdccmmacpofcla.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNraG52ZGZkY2NtbWFjcG9mY2xhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTU4NDA1OTEsImV4cCI6MjAzMTQxNjU5MX0.m89dtPlI3T-CZXtzHJ-SAC-D00G8KkFuNH_p-4H4lHA';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        let roomId = null;
        let previousResultCount = 0;

        // Check for uuid in local storage
        let user = localStorage.getItem('user')

        // If the uuid is not found, create a new one
        if (!user) {
            user = crypto.randomUUID()
            localStorage.setItem('user', user)
        }

        // Handle when the user selects a room
        document.querySelector('#select-room').addEventListener('click', async () => {
            roomId = document.querySelector('#room').value
           
            const result = await getBirthdays()
            if (result === false) {
                return
            }

            previousResultCount = 0

            // Check if we haven't already stored this birthday
            if (localStorage.getItem(roomId)) {
                console.log('Birthday already stored')
                document.querySelector('#room-selection').style.display = 'none'
                document.querySelector('#results').style.display = 'block'
                return
            }
            document.querySelector('#room-selection').style.display = 'none'
            document.querySelector('#enter-birthday').style.display = 'block'
        })

        // Handle when the user creates a new room
        document.querySelector('#create-room').addEventListener('click', async () => {
            document.querySelector('#room-selection').style.display = 'none'
            document.querySelector('#enter-birthday').style.display = 'block'
        })

        // Handle when the user submits a birthday
        document.querySelector('#submit-birthday').addEventListener('click', async () => {
            const birthday = document.querySelector('#birthday').value
            await submitBirthday(birthday)
            document.querySelector('#enter-birthday').style.display = 'none'
            document.querySelector('#results').style.display = 'block'
            getBirthdays()
        })

        // Handle when the user clicks the home button
        document.querySelector('#Home').addEventListener('click', () => {
            window.location.reload()
        })

        // Every second, get the latest results
        setInterval(() => {
            getBirthdays()
        }, 1000)

        async function getBirthdays() {

            if(!roomId) return

            
            // Get all the birthdays in this room
            const {data, error} = await supabaseClient.from('birthdays').select().eq('room', roomId)

            if (error) {
                console.error('Error getting data:', error.message)
                return
            }

            console.log('Data found:', data)

            // If the data is empty, reload the page to reset
            if (data.length === 0) {
                // Show an error message
                document.querySelector('#error').style.display = 'block'
                setTimeout(() => {
                    document.querySelector('#error').style.display = 'none'
                }, 3000)
                return false
            }

            if(previousResultCount === data.length) return

            // Show the room id
            document.querySelector('#room-id').innerText = `Room ID: ${roomId}`
            
            previousResultCount = data.length

            // See if there any duplicates
            let duplicates = data.reduce((acc, birthday) => {
                if (acc[birthday.birthday]) {
                    acc[birthday.birthday]++
                } else {
                    acc[birthday.birthday] = 1
                }
                return acc
            }, {})

            // Sort the birthdays by the number of duplicates
            data.sort((a, b) => duplicates[b.birthday] - duplicates[a.birthday])

            // Display the birthdays in the DOM
            const birthdays = data.map(birthday => {

                if(duplicates[birthday.birthday] === 0) return
                
                let count = duplicates[birthday.birthday];
                
                // Set the count to zero to indicate it has been printed
                duplicates[birthday.birthday] = 0
                
                // Convert to a human-readable date, removing the year
                birthday.birthday = new Date(birthday.birthday).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })

                if (count > 1) {
                    return `<p>${birthday.birthday} (${count} people)</p>`
                }

                return `<p>${birthday.birthday}</p>`
            })

            document.querySelector('#birthdays').innerHTML = birthdays.join('')
        }

        async function submitBirthday(birthday) {

            if(!roomId){
                // Truncated uuid
                roomId = crypto.randomUUID().slice(0, 6)
            }

            previousResultCount = 0

            let data = { birthday: birthday, created_by: user, room: roomId}

            const { error } = await supabaseClient.from('birthdays').insert(data)

            if (error) {
                console.error('Error inserting data:', error.message)
                return
            }

            console.log('Data inserted successfully')

            // Store the room id in the local storage
            localStorage.setItem(roomId, birthday)

            // Hide the birthday input
            document.querySelector('#birthday').style.display = 'none'
        }

    </script>
</body>
</html>
